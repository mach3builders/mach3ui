/* ==========================================================================
   Dropdown / Menu — Flux-matching native CSS
   Uses the Popover API + CSS Anchor Positioning for fully CSS-based
   toggle, positioning, and viewport-aware flipping. Zero JavaScript.

   <div class="ui-dropdown">
     <button class="ui-btn" popovertarget="id">Trigger</button>
     <div class="ui-menu" popover id="id">...items...</div>
   </div>
   ========================================================================== */

@layer ui.components {

    /* -- Dropdown wrapper ---------------------------------------------------- */

    .ui-dropdown {
        position: relative;
        display: inline-flex;
    }

    /* Chevron icon in trigger */
    .ui-dropdown > [popovertarget] > svg:last-child {
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
    }

    /* -- Menu panel ---------------------------------------------------------- */

    .ui-menu {
        min-width: 12rem;
        padding: 0.3125rem;
        border-radius: var(--ui-radius-lg, 8px);
        box-shadow: var(--shadow-xs, 0 1px 2px rgb(0 0 0 / 0.05));
        border: 1px solid var(--color-gray-200);
        background: #ffffff;
    }

    /* -- Popover + Anchor Positioning ----------------------------------------
       Each popover uses its invoker (the [popovertarget] button) as its
       implicit anchor — no anchor-name needed, so multiple dropdowns
       on the same page each anchor to their own trigger.
       ---------------------------------------------------------------------- */

    .ui-dropdown > .ui-menu[popover] {
        inset: unset;
        margin: 0;

        /* Default: bottom start */
        top: anchor(bottom);
        left: anchor(left);
        margin-top: 0.25rem;

        /* Flip to top when no room at bottom */
        position-try-fallbacks: --ui-flip-top;
    }

    @position-try --ui-flip-top {
        inset: unset;
        bottom: anchor(top);
        left: anchor(left);
        margin: 0 0 0.25rem;
    }

    /* Reset popover backdrop */
    .ui-dropdown > .ui-menu[popover]::backdrop {
        background: transparent;
    }

    /* -- Position: bottom end ------------------------------------------------ */

    .ui-dropdown-end > .ui-menu[popover] {
        left: unset;
        right: anchor(right);
        position-try-fallbacks: --ui-flip-top-end;
    }

    @position-try --ui-flip-top-end {
        inset: unset;
        bottom: anchor(top);
        right: anchor(right);
        margin: 0 0 0.25rem;
    }

    /* -- Position: bottom center --------------------------------------------- */

    .ui-dropdown-center > .ui-menu[popover] {
        left: anchor(center);
        translate: -50% 0;
        position-try-fallbacks: --ui-flip-top-center;
    }

    @position-try --ui-flip-top-center {
        inset: unset;
        bottom: anchor(top);
        left: anchor(center);
        translate: -50% 0;
        margin: 0 0 0.25rem;
    }

    /* -- Position: top start ------------------------------------------------- */

    .ui-dropdown-top > .ui-menu[popover] {
        top: unset;
        bottom: anchor(top);
        left: anchor(left);
        margin-top: 0;
        margin-bottom: 0.25rem;
        position-try-fallbacks: --ui-flip-bottom;
    }

    @position-try --ui-flip-bottom {
        inset: unset;
        top: anchor(bottom);
        left: anchor(left);
        margin: 0.25rem 0 0;
    }

    /* -- Position: top end --------------------------------------------------- */

    .ui-dropdown-top.ui-dropdown-end > .ui-menu[popover] {
        top: unset;
        bottom: anchor(top);
        left: unset;
        right: anchor(right);
        margin-top: 0;
        margin-bottom: 0.25rem;
        position-try-fallbacks: --ui-flip-bottom-end;
    }

    @position-try --ui-flip-bottom-end {
        inset: unset;
        top: anchor(bottom);
        right: anchor(right);
        margin: 0.25rem 0 0;
    }

    /* -- Position: top center ------------------------------------------------ */

    .ui-dropdown-top.ui-dropdown-center > .ui-menu[popover] {
        top: unset;
        bottom: anchor(top);
        left: anchor(center);
        translate: -50% 0;
        margin-top: 0;
        margin-bottom: 0.25rem;
        position-try-fallbacks: --ui-flip-bottom-center;
    }

    @position-try --ui-flip-bottom-center {
        inset: unset;
        top: anchor(bottom);
        left: anchor(center);
        translate: -50% 0;
        margin: 0.25rem 0 0;
    }

    /* -- Position: right ----------------------------------------------------- */

    .ui-dropdown-right > .ui-menu[popover] {
        top: anchor(top);
        left: anchor(right);
        margin-top: 0;
        margin-left: 0.25rem;
        position-try-fallbacks: --ui-flip-left;
    }

    @position-try --ui-flip-left {
        inset: unset;
        top: anchor(top);
        right: anchor(left);
        margin: 0 0.25rem 0 0;
    }

    /* -- Position: right end ------------------------------------------------- */

    .ui-dropdown-right.ui-dropdown-end > .ui-menu[popover] {
        top: unset;
        bottom: anchor(bottom);
        left: anchor(right);
        margin-top: 0;
        margin-left: 0.25rem;
        position-try-fallbacks: --ui-flip-left-end;
    }

    @position-try --ui-flip-left-end {
        inset: unset;
        bottom: anchor(bottom);
        right: anchor(left);
        margin: 0 0.25rem 0 0;
    }

    /* -- Position: left ------------------------------------------------------ */

    .ui-dropdown-left > .ui-menu[popover] {
        top: anchor(top);
        left: unset;
        right: anchor(left);
        margin-top: 0;
        margin-right: 0.25rem;
        position-try-fallbacks: --ui-flip-right;
    }

    @position-try --ui-flip-right {
        inset: unset;
        top: anchor(top);
        left: anchor(right);
        margin: 0 0 0 0.25rem;
    }

    /* -- Position: left end -------------------------------------------------- */

    .ui-dropdown-left.ui-dropdown-end > .ui-menu[popover] {
        top: unset;
        bottom: anchor(bottom);
        left: unset;
        right: anchor(left);
        margin-top: 0;
        margin-right: 0.25rem;
        position-try-fallbacks: --ui-flip-right-end;
    }

    @position-try --ui-flip-right-end {
        inset: unset;
        bottom: anchor(bottom);
        left: anchor(right);
        margin: 0 0 0 0.25rem;
    }

    /* -- Item ---------------------------------------------------------------- */

    .ui-menu-item {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.5rem;
        width: 100%;
        border-radius: var(--ui-radius, 6px);
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-gray-800);
        text-decoration: none;
        text-align: start;
        cursor: pointer;
        border: none;
        background: none;
    }

    .ui-menu-item:hover,
    .ui-menu-item[data-active] {
        background: var(--color-gray-50);
    }

    .ui-menu-item[disabled],
    .ui-menu-item-disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* -- Danger variant ------------------------------------------------------ */

    .ui-menu-item-danger {
        color: var(--color-gray-800);
    }

    .ui-menu-item-danger:hover,
    .ui-menu-item-danger[data-active] {
        color: var(--color-red-600, oklch(57.7% 0.245 27.325));
        background: var(--color-red-50, oklch(97.1% 0.013 17.38));
    }

    /* -- Icon ---------------------------------------------------------------- */

    .ui-menu-item > svg:first-child {
        margin-inline-end: 0.5rem;
        width: 1.25rem;
        height: 1.25rem;
        color: var(--color-gray-400);
        flex-shrink: 0;
    }

    .ui-menu-item:hover > svg:first-child,
    .ui-menu-item[data-active] > svg:first-child {
        color: currentColor;
    }

    /* Trailing icon */
    .ui-menu-item > svg:last-child:not(:first-child) {
        margin-inline-start: auto;
        width: 1.25rem;
        height: 1.25rem;
        color: var(--color-gray-400);
        flex-shrink: 0;
    }

    .ui-menu-item:hover > svg:last-child:not(:first-child),
    .ui-menu-item[data-active] > svg:last-child:not(:first-child) {
        color: currentColor;
    }

    /* -- Keyboard shortcut --------------------------------------------------- */

    .ui-menu-kbd {
        margin-inline-start: auto;
        font-size: 0.75rem;
        color: var(--color-gray-400);
    }

    /* -- Separator ----------------------------------------------------------- */

    .ui-menu-separator {
        margin-inline: -0.3125rem;
        margin-block: 0.3125rem;
        height: 1px;
        background: var(--color-gray-200);
    }

    /* -- Heading ------------------------------------------------------------- */

    .ui-menu-heading {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.5rem 0.25rem;
        width: 100%;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--color-gray-500);
        text-align: start;
    }

    /* -- Checkbox / Radio ---------------------------------------------------- */

    .ui-menu-check {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.5rem;
        width: 100%;
        border-radius: var(--ui-radius, 6px);
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-gray-800);
        text-align: start;
        cursor: pointer;
        border: none;
        background: none;
    }

    .ui-menu-check:hover,
    .ui-menu-check[data-active] {
        background: var(--color-gray-50);
    }

    .ui-menu-check-icon {
        width: 1.75rem;
        flex-shrink: 0;
        display: flex;
        align-items: center;
    }

    .ui-menu-check-icon > svg {
        width: 1rem;
        height: 1rem;
        display: none;
    }

    .ui-menu-check[aria-checked="true"] > .ui-menu-check-icon > svg {
        display: block;
    }

    /* ========================================================================
       Dark mode — explicit (`data-theme="dark"`)
       ======================================================================== */

    .ui[data-theme="dark"] .ui-menu {
        border-color: var(--color-gray-600);
        background: var(--color-gray-700);
    }

    .ui[data-theme="dark"] .ui-menu-item {
        color: #ffffff;
    }

    .ui[data-theme="dark"] .ui-menu-item:hover,
    .ui[data-theme="dark"] .ui-menu-item[data-active] {
        background: var(--color-gray-600);
    }

    .ui[data-theme="dark"] .ui-menu-item-danger:hover,
    .ui[data-theme="dark"] .ui-menu-item-danger[data-active] {
        color: var(--color-red-400, oklch(70.4% 0.191 22.216));
        background: color-mix(in oklab, var(--color-red-400, oklch(70.4% 0.191 22.216)) 20%, transparent);
    }

    .ui[data-theme="dark"] .ui-menu-item > svg:first-child {
        color: rgb(255 255 255 / 0.6);
    }

    .ui[data-theme="dark"] .ui-menu-item > svg:last-child:not(:first-child) {
        color: rgb(255 255 255 / 0.6);
    }

    .ui[data-theme="dark"] .ui-menu-kbd {
        color: var(--color-gray-400);
    }

    .ui[data-theme="dark"] .ui-menu-separator {
        background: var(--color-gray-600);
    }

    .ui[data-theme="dark"] .ui-menu-heading {
        color: var(--color-gray-300);
    }

    .ui[data-theme="dark"] .ui-menu-check {
        color: #ffffff;
    }

    .ui[data-theme="dark"] .ui-menu-check:hover,
    .ui[data-theme="dark"] .ui-menu-check[data-active] {
        background: var(--color-gray-600);
    }

    /* ========================================================================
       Dark mode — automatic fallback (`prefers-color-scheme`)
       ======================================================================== */

    @media (prefers-color-scheme: dark) {
        .ui:not([data-theme]) .ui-menu {
            border-color: var(--color-gray-600);
            background: var(--color-gray-700);
        }

        .ui:not([data-theme]) .ui-menu-item {
            color: #ffffff;
        }

        .ui:not([data-theme]) .ui-menu-item:hover,
        .ui:not([data-theme]) .ui-menu-item[data-active] {
            background: var(--color-gray-600);
        }

        .ui:not([data-theme]) .ui-menu-item-danger:hover,
        .ui:not([data-theme]) .ui-menu-item-danger[data-active] {
            color: var(--color-red-400, oklch(70.4% 0.191 22.216));
            background: color-mix(in oklab, var(--color-red-400, oklch(70.4% 0.191 22.216)) 20%, transparent);
        }

        .ui:not([data-theme]) .ui-menu-item > svg:first-child {
            color: rgb(255 255 255 / 0.6);
        }

        .ui:not([data-theme]) .ui-menu-item > svg:last-child:not(:first-child) {
            color: rgb(255 255 255 / 0.6);
        }

        .ui:not([data-theme]) .ui-menu-kbd {
            color: var(--color-gray-400);
        }

        .ui:not([data-theme]) .ui-menu-separator {
            background: var(--color-gray-600);
        }

        .ui:not([data-theme]) .ui-menu-heading {
            color: var(--color-gray-300);
        }

        .ui:not([data-theme]) .ui-menu-check {
            color: #ffffff;
        }

        .ui:not([data-theme]) .ui-menu-check:hover,
        .ui:not([data-theme]) .ui-menu-check[data-active] {
            background: var(--color-gray-600);
        }
    }
}
